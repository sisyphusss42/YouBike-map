<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>YouBike Ëá∫Â§ßÊ†°ÂçÄÂú∞Âúñ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html {
      margin: 0;
      height: 100%;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
    }
    #controls {
      background: #fff;
      padding: 0.5em;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1em;
      z-index: 1000;
    }
    #map {
      flex: 1;
      width: 100%;
    }
    button {
      padding: 0.5em 1em;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
      background: #eee;
    }
    button.active {
      background: #007bff;
      color: white;
    }
    /* Custom marker style */
    .marker {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      color: white;
      border: 2px solid #333;
    }
    .legend {
      background: white;
      padding: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="controls">
    <button id="borrowBtn" class="active">üö≤ ÂÄüËªäÊ®°Âºè</button>
    <button id="parkBtn">üÖøÔ∏è ÈÇÑËªäÊ®°Âºè</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const extraStations = new Set([
      "500101181","500101022","500106003","500101021","500106135",
      "500106002","500101023","500106001","500106090","500101184",
      "500101010","500101009","500101008","500101040","500101216",
      "500101041","500101008","500101014","500106012","500106011",
      "500101207","500106007","500101104","500101012","500101016"
    ]);

    let mode = "borrow"; // default mode
    let map = L.map('map').setView([25.011, 121.535], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let markers = [];

    function timeAgo(dateStr) {
      const now = new Date();
      const past = new Date(dateStr);
      const diffMs = now - past;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHour = Math.floor(diffMin / 60);

      if (diffSec < 60) return `${diffSec} ÁßíÂâç`;
      if (diffMin < 60) return `${diffMin} ÂàÜÈêòÂâç`;
      if (diffHour < 24) return `${diffHour} Â∞èÊôÇÂâç`;
      const diffDay = Math.floor(diffHour / 24);
      return `${diffDay} Â§©Ââç`;
    }

    function getMarkerIcon(st) {
      let value;
      if (mode === "borrow") {
        value = st.available_rent_bikes;
      } else {
        value = st.available_return_bikes;
      }

      let color = "green";
      if (value === 0) color = "red";
      else if (value <= 5) color = "orange";

      // Only show number if value is between 1-5 (orange markers)
      const text = (value >= 1 && value <= 5) ? value : "";

      return L.divIcon({
        className: "custom-marker",
        html: `<div class="marker" style="background:${color}">${text}</div>`,
        iconSize: [28, 28],
        iconAnchor: [14, 14]
      });
    }

    async function loadStations() {
      const url = "https://tcgbusfs.blob.core.windows.net/dotapp/youbike/v2/youbike_immediate.json";
      try {
        const res = await fetch(url);
        const data = await res.json();
        const selectedStations = data.filter(st =>
          st.sarea === "Ëá∫Â§ßÂÖ¨È§®Ê†°ÂçÄ" || extraStations.has(st.sno)
        );

        // Clear old markers
        markers.forEach(m => map.removeLayer(m));
        markers = [];

        let bounds = [];

        selectedStations.forEach(st => {
          const displayName = st.sna.replace("YouBike2.0_", "");
          const relativeTime = timeAgo(st.srcUpdateTime);

          const marker = L.marker([st.latitude, st.longitude], {
            icon: getMarkerIcon(st)
          }).bindPopup(`<b>${displayName}</b><br>
              ÂèØÂÄüÔºö${st.available_rent_bikes} | ÂèØÈÇÑÔºö${st.available_return_bikes}<br>
              Êõ¥Êñ∞Ôºö${relativeTime}`);
          marker.addTo(map);
          markers.push(marker);

          bounds.push([st.latitude, st.longitude]);
        });

        if (bounds.length) {
          map.fitBounds(bounds, { padding: [20, 20] });
        }
      } catch (err) {
        alert("ËÆÄÂèñÂ§±Êïó üò¢");
        console.error(err);
      }
    }

    // Initial load
    loadStations();
    setInterval(loadStations, 60 * 1000); // update every minute

    // Toggle buttons
    document.getElementById("borrowBtn").onclick = () => {
      mode = "borrow";
      document.getElementById("borrowBtn").classList.add("active");
      document.getElementById("parkBtn").classList.remove("active");
      loadStations();
    };

    document.getElementById("parkBtn").onclick = () => {
      mode = "park";
      document.getElementById("parkBtn").classList.add("active");
      document.getElementById("borrowBtn").classList.remove("active");
      loadStations();
    };

    // Add bottom-right control for School/Home
    const LocationControl = L.Control.extend({
      options: { position: 'bottomright' },
      onAdd: function() {
        const container = L.DomUtil.create('div', 'legend');
        container.innerHTML = `
          <button id="schoolBtn">üéì Ê†°ÂçÄ</button>
          <button id="homeBtn">üè† ‰ΩèÂÆ∂</button>
        `;
        return container;
      }
    });
    map.addControl(new LocationControl());

    // Hook up events after control is added
    setTimeout(() => {
      document.getElementById("schoolBtn").onclick = () => {
        map.setView([25.011, 121.535], 16); // NTU campus
      };
      document.getElementById("homeBtn").onclick = () => {
        map.setView([25.00290883787547, 121.45428178671068], 16); // Home
      };
    }, 500);
  </script>
</body>
</html>